# Trading Bot Database Architecture

## Overview

This document describes the complete relational database schema and C# architecture for the full-featured trading bot system using Entity Framework Core.

## Database Schema

### Core Entities

#### 1. **Assets**
Stores all tradable assets (stocks, crypto, options)
- Primary Key: `Id` (Guid)
- Unique Index: `Symbol`
- Relationships:
  - One-to-Many with `StockQuoteSnapshots`, `StockBarData`, `CryptoQuoteSnapshots`, `CryptoBarData`
  - One-to-Many with `OptionContracts`, `Trades`, `Positions`

#### 2. **PolymarketEvents**
Stores Polymarket prediction market events being tracked
- Primary Key: `Id` (Guid)
- Unique Index: `EventId`
- Relationships:
  - One-to-Many with `PolymarketMarkets`
  - One-to-Many with `Trades`, `Positions`

#### 3. **PolymarketMarkets**
Stores individual markets within Polymarket events
- Primary Key: `Id` (Guid)
- Foreign Key: `PolymarketEventId` → `PolymarketEvents.Id`
- Relationships:
  - Many-to-One with `PolymarketEvents`
  - One-to-Many with `PolymarketSnapshots`

### Market Data Entities

#### 4. **StockQuoteSnapshots**
Real-time/historical stock quotes from Alpaca
- Indexed by: `AssetId`, `QuoteTimestamp`, `Symbol`
- Contains: Bid, Ask, MidPrice, Sizes

#### 5. **StockBarData**
Historical OHLCV candlestick data for stocks
- Indexed by: `AssetId`, `Timeframe`, `BarTimestamp`
- Contains: Open, High, Low, Close, Volume, VWAP

#### 6. **CryptoQuoteSnapshots**
Real-time/historical crypto quotes from Alpaca
- Similar structure to StockQuoteSnapshots
- Decimal sizes for crypto precision

#### 7. **CryptoBarData**
Historical OHLCV candlestick data for crypto
- Similar structure to StockBarData
- Decimal volume for crypto precision

#### 8. **OptionContracts**
Options contract metadata from Alpaca
- Contains: Strike price, expiration, option type (call/put), Greeks
- Unique Index: `ContractId`
- One-to-Many with `OptionQuoteSnapshots`

#### 9. **OptionQuoteSnapshots**
Options quotes with Greeks and Implied Volatility
- Contains: Bid, Ask, IV, Delta, Gamma, Theta, Vega, Rho
- Critical for options trading strategies

#### 10. **PolymarketSnapshots**
Real-time market data from Polymarket WebSocket
- Contains: Price, Bid, Ask, **Implied Volatility**, Volume, Liquidity
- Indexed by: `PolymarketMarketId`, `SnapshotTimestamp`

#### 11. **PolymarketTradeData**
Trade execution data from Polymarket
- Contains: Price, Size, Side, Maker/Taker addresses
- Unique Index: `TradeId`

#### 12. **PolymarketOrderBookSnapshots**
Order book depth snapshots from Polymarket
- Contains: Bids, Asks (JSON arrays), Total sizes

### Trading Entities

#### 13. **Strategies**
Trading strategies/algorithms
- Contains: Name, Type, Configuration (JSON), Risk parameters
- One-to-Many with `TradingSignals`, `Trades`

#### 14. **TradingSignals**
Signals generated by strategies
- Foreign Keys: `StrategyId`, `AssetId`, `PolymarketEventId`
- Contains: Signal type (Buy/Sell), Confidence, Target price, Stop loss
- **SourceData** (JSON): Contains Alpaca/Polymarket data that triggered the signal
- One-to-Many with `Trades`

#### 15. **Trades**
Executed trades (buy/sell transactions)
- Foreign Keys: `StrategyId`, `SignalId`, `AssetId`, `PolymarketEventId`, `PositionId`
- Contains: Type, Side, Quantity, Price, Commission, Status
- **AlpacaMarketDataSnapshot** (JSON): Market data from Alpaca at trade time
- **PolymarketDataSnapshot** (JSON): Market data from Polymarket at trade time
- Indexed by: `ExecutedAt`, `Status`, `Symbol`

#### 16. **Positions**
Trading positions (both open and closed)
- Foreign Keys: `AssetId`, `PolymarketEventId`
- Contains: Side (Long/Short), Status, Quantity, Entry/Exit prices, P&L
- **AlpacaOpenSnapshot** / **AlpacaCloseSnapshot** (JSON): Market data at position open/close
- **PolymarketOpenSnapshot** / **PolymarketCloseSnapshot** (JSON): Market data at position open/close
- One-to-Many with `Trades`
- Indexed by: `Status`, `OpenedAt`, `ClosedAt`

### Logging Entities

#### 17. **ApplicationLogs**
Application-level logging
- Contains: LogLevel, Category, Message, Exception, StackTrace
- Indexed by: `LogLevel`, `LogTimestamp`, `CorrelationId`

#### 18. **ErrorLogs**
Error and exception tracking
- Contains: Severity, Category, ErrorCode, Exception details
- Tracks: Whether handled, requires intervention, resolution
- Indexed by: `Severity`, `ErrorTimestamp`, `WasHandled`

#### 19. **PerformanceMetrics**
System performance monitoring
- Contains: Metric name, Value, Unit, Source
- Examples: API latency, query times, signal generation time
- Indexed by: `MetricName`, `MetricTimestamp`

#### 20. **AuditLogs**
Audit trail for critical operations
- Contains: Action, Entity type/ID, Performed by, Changes (JSON)
- Tracks state changes with before/after snapshots
- Indexed by: `EntityType`, `EntityId`, `ActionTimestamp`

## Key Relationships

```
Asset ──┬── StockQuoteSnapshots
        ├── StockBarData
        ├── CryptoQuoteSnapshots
        ├── CryptoBarData
        ├── OptionContracts ─── OptionQuoteSnapshots
        ├── Trades
        └── Positions ─── Trades

PolymarketEvent ──┬── PolymarketMarkets ─── PolymarketSnapshots
                  ├── Trades
                  └── Positions

Strategy ──┬── TradingSignals ─── Trades
           └── Trades

Position ─── Trades (multiple trades can be part of one position)
```

## C# Architecture

### 1. **Domain Models** (`/Data/Domain/`)
- `BaseEntity.cs` - Base class with Id, timestamps, soft delete
- `Asset.cs` - Tradable assets
- `PolymarketEventData.cs` - Polymarket events and markets
- `AlpacaMarketData.cs` - Stock/Crypto/Options market data
- `PolymarketMarketDataStorage.cs` - Polymarket snapshots
- `Strategy.cs` - Trading strategies and signals
- `Trade.cs` - Trade entities
- `Position.cs` - Position entities
- `Logging.cs` - Logging, errors, metrics, audit logs

### 2. **EF Core Configurations** (`/Data/Configurations/`)
- `AssetConfiguration.cs`
- `AlpacaMarketDataConfiguration.cs`
- `PolymarketConfiguration.cs`
- `StrategyConfiguration.cs`
- `TradeConfiguration.cs`
- `LoggingConfiguration.cs`

Uses Fluent API for:
- Table mapping
- Column types and precision (decimal(18,8))
- Indexes for query performance
- Relationships and foreign keys
- Query filters (soft delete)

### 3. **DbContext** (`/Data/TradingBotDbContext.cs`)
Features:
- All DbSets for entities
- Automatic timestamp updates (CreatedAt, UpdatedAt)
- Soft delete implementation
- UTC datetime handling
- Configuration auto-discovery

### 4. **Repository Layer** (`/Data/Repositories/`)

#### Generic Repository
- `IRepository<T>` - Interface with CRUD operations
- `Repository<T>` - Base implementation

#### Specialized Repositories
- `ITradeRepository` / `TradeRepository` - Trade queries, statistics
- `IPositionRepository` / `PositionRepository` - Position management, P&L calculations
- `IAssetRepository` / `AssetRepository` - Asset lookups
- `IStrategyRepository` / `StrategyRepository` - Strategy management
- `ITradingSignalRepository` / `TradingSignalRepository` - Signal queries
- `IPolymarketEventRepository` / `PolymarketEventRepository` - Event management
- Market data repositories for stocks, crypto, Polymarket snapshots

### 5. **Service Layer** (`/Data/Services/`)

#### ITradingService / TradingService
High-level trading operations:
- `ExecuteMarketOrderAsync()` - Execute market orders
- `ExecuteLimitOrderAsync()` - Execute limit orders
- `OpenPositionAsync()` - Open new positions
- `ClosePositionAsync()` - Close positions
- `GetPortfolioSummaryAsync()` - Portfolio overview
- `GetPortfolioPerformanceAsync()` - Performance metrics

#### IMarketDataService
Market data storage and retrieval:
- `StoreStockQuoteAsync()` - Store Alpaca stock quotes
- `StoreStockBarAsync()` - Store stock candles
- `StoreCryptoQuoteAsync()` - Store crypto quotes
- `StorePolymarketSnapshotAsync()` - Store Polymarket data
- Query methods for historical data

### 6. **DTOs** (`/Data/DTOs/TradingDtos.cs`)
- `TradeDto`, `CreateTradeRequest`
- `PositionDto`, `OpenPositionRequest`
- `PortfolioSummaryDto`, `PortfolioPerformanceDto`
- `StrategyDto`, `TradingSignalDto`
- `AssetDto`, `MarketBarDto`
- `PolymarketEventDto`

## Database Setup

### 1. **Connection String Configuration**

Add to `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "TradingBotDatabase": "Server=(localdb)\\mssqllocaldb;Database=TradingBot;Trusted_Connection=true;MultipleActiveResultSets=true",
    "PostgreSQL": "Host=localhost;Database=tradingbot;Username=postgres;Password=yourpassword"
  }
}
```

### 2. **Register DbContext in Program.cs**

```csharp
using Medalion.Data;
using Medalion.Data.Repositories;
using Medalion.Data.Services;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add DbContext
// For SQL Server:
builder.Services.AddDbContext<TradingBotDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("TradingBotDatabase")));

// OR For PostgreSQL:
// builder.Services.AddDbContext<TradingBotDbContext>(options =>
//     options.UseNpgsql(builder.Configuration.GetConnectionString("PostgreSQL")));

// Register Repositories
builder.Services.AddScoped(typeof(IRepository<>), typeof(Repository<>));
builder.Services.AddScoped<ITradeRepository, TradeRepository>();
builder.Services.AddScoped<IPositionRepository, PositionRepository>();
builder.Services.AddScoped<IAssetRepository, AssetRepository>();
builder.Services.AddScoped<IStrategyRepository, StrategyRepository>();
builder.Services.AddScoped<ITradingSignalRepository, TradingSignalRepository>();
builder.Services.AddScoped<IPolymarketEventRepository, PolymarketEventRepository>();
builder.Services.AddScoped<IStockBarDataRepository, StockBarDataRepository>();
builder.Services.AddScoped<IStockQuoteSnapshotRepository, StockQuoteSnapshotRepository>();
builder.Services.AddScoped<ICryptoBarDataRepository, CryptoBarDataRepository>();
builder.Services.AddScoped<IPolymarketSnapshotRepository, PolymarketSnapshotRepository>();

// Register Services
builder.Services.AddScoped<ITradingService, TradingService>();
// Add IMarketDataService implementation when needed

var app = builder.Build();

// ... rest of app configuration
```

### 3. **Generate Initial Migration**

```bash
# Restore packages
dotnet restore

# Create initial migration
dotnet ef migrations add InitialCreate --project medalion

# Apply migration to database
dotnet ef database update --project medalion
```

### 4. **Generate SQL Script** (optional)

```bash
# Generate SQL script for review
dotnet ef migrations script --project medalion --output schema.sql
```

## Key Features

### 1. **Comprehensive Data Storage**
- All Alpaca market data (stocks, crypto, options with Greeks/IV)
- All Polymarket event data (snapshots with IV, trades, order books)
- Complete trading history with source data snapshots

### 2. **Trading Decision Traceability**
Every trade stores:
- The strategy and signal that triggered it
- Complete market data snapshot from both Alpaca and Polymarket at decision time
- Position relationship for P&L tracking

### 3. **Position Management**
- Open and closed positions tracked separately
- Unrealized P&L for open positions
- Realized P&L for closed positions
- Entry and exit market data snapshots

### 4. **Performance Analytics**
- Trade statistics (win rate, profit factor, etc.)
- Portfolio performance metrics
- Position-level P&L tracking
- Commission tracking

### 5. **Audit Trail**
- Complete logging infrastructure
- Error tracking with severity levels
- Performance metrics
- Audit logs for critical operations

### 6. **Soft Delete**
All entities support soft delete - records are marked as deleted but not physically removed

### 7. **Async Operations**
All repository and service methods are async for optimal performance

## Query Patterns

### Common Queries

```csharp
// Get all open positions
var openPositions = await tradingService.GetOpenPositionsAsync();

// Get portfolio summary
var summary = await tradingService.GetPortfolioSummaryAsync();

// Get trade statistics for last 30 days
var stats = await tradeRepository.GetTradeStatisticsAsync(
    DateTime.UtcNow.AddDays(-30),
    DateTime.UtcNow);

// Get stock bars for technical analysis
var bars = await marketDataService.GetStockBarsAsync(
    assetId,
    "1Day",
    startDate,
    endDate);

// Get latest Polymarket snapshot
var snapshot = await marketDataService.GetLatestPolymarketSnapshotAsync(marketId);

// Get active trading signals
var signals = await signalRepository.GetActiveSignalsAsync();
```

## Next Steps

1. **Restore packages**: `dotnet restore`
2. **Generate migration**: `dotnet ef migrations add InitialCreate`
3. **Create database**: `dotnet ef database update`
4. **Implement MarketDataService** (interface provided, implementation needed)
5. **Create seed data** for testing
6. **Integrate with existing Alpaca and Polymarket services**

## Notes

- All decimal fields use precision(18,8) for financial accuracy
- Timestamps are stored in UTC
- JSON columns store complex nested data (configurations, snapshots, etc.)
- Indexes are optimized for time-series queries
- Foreign key relationships use `DeleteBehavior.Restrict` for trades/positions to prevent accidental data loss
